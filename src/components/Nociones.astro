<section id="nociones" class="bg-background-alt/40 py-16">
  <div class="mx-auto max-w-7xl px-6">
    <div class="text-center">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-secondary">Nociones</p>
      <h2 class="font-display text-3xl text-text-main sm:text-4xl">Bases que sostienen cada sesión</h2>
      <p class="mt-4 text-sm text-slate-600">
        Principios integrados para acompañar procesos de sanación y rejuvenecimiento.
      </p>
    </div>
    <div class="relative mt-12 overflow-hidden select-none cursor-grab touch-pan-y" data-carousel="nociones">
      <div class="flex gap-8" data-carousel-track>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">autorenew</span>
        <h3 class="mt-4 text-lg font-semibold">Energía sutil</h3>
        <p class="mt-2 text-sm text-slate-600">Canalización, limpieza y equilibrio de centros energéticos.</p>
      </article>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">face</span>
        <h3 class="mt-4 text-lg font-semibold">Reflexología facial</h3>
        <p class="mt-2 text-sm text-slate-600">Estimulación de puntos reflejos para activar procesos internos.</p>
      </article>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">spa</span>
        <h3 class="mt-4 text-lg font-semibold">Ritual de cuidado</h3>
        <p class="mt-2 text-sm text-slate-600">Masajes, aromas y respiración consciente para relajar y nutrir.</p>
      </article>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">self_improvement</span>
        <h3 class="mt-4 text-lg font-semibold">Meditación guiada</h3>
        <p class="mt-2 text-sm text-slate-600">Visualizaciones y anclajes para volver al centro.</p>
      </article>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">favorite</span>
        <h3 class="mt-4 text-lg font-semibold">Bienestar emocional</h3>
        <p class="mt-2 text-sm text-slate-600">Trabajo con emociones para sostener cambios internos reales.</p>
      </article>
        <article class="w-full shrink-0 rounded-3xl bg-white p-6 shadow-sm sm:w-1/2 lg:w-1/3" data-carousel-item>
        <span class="material-icons text-primary">psychology</span>
        <h3 class="mt-4 text-lg font-semibold">Consciencia corporal</h3>
        <p class="mt-2 text-sm text-slate-600">Lectura del cuerpo y hábitos que favorecen la regeneración.</p>
      </article>
      </div>
    </div>
  </div>
</section>

<script>
  const initNocionesCarousel = () => {
    const carousel = document.querySelector('[data-carousel="nociones"]');
    if (!carousel) return;

    const track = carousel.querySelector<HTMLElement>('[data-carousel-track]');
    if (!track) return;

    const originals = Array.from(track.querySelectorAll<HTMLElement>('[data-carousel-item]'));
    if (originals.length <= 1) return;

    const headClones = originals.map((item) => item.cloneNode(true) as HTMLElement);
    const tailClones = originals.map((item) => item.cloneNode(true) as HTMLElement);

    headClones.reverse().forEach((clone) => {
      clone.setAttribute('data-clone', 'true');
      track.prepend(clone);
    });

    tailClones.forEach((clone) => {
      clone.setAttribute('data-clone', 'true');
      track.append(clone);
    });

    const total = originals.length;
    let index = total;
    let intervalId = 0;
    let isAnimating = false;
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;

    const getGap = () => parseFloat(getComputedStyle(track).gap || '0');
    const getItemWidth = () => originals[0].offsetWidth;

    const moveTo = (nextIndex: number, { animate = true }: { animate?: boolean } = {}) => {
      const gap = getGap();
      const width = getItemWidth();
      track.style.transition = animate ? 'transform 700ms ease-in-out' : 'none';
      track.style.transform = `translateX(-${nextIndex * (width + gap)}px)`;
      index = nextIndex;
      if (!animate) {
        requestAnimationFrame(() => {
          track.style.transition = 'transform 700ms ease-in-out';
        });
      }
    };

    const next = () => {
      if (isAnimating) return;
      isAnimating = true;
      moveTo(index + 1);
    };

    const prev = () => {
      if (isAnimating) return;
      isAnimating = true;
      moveTo(index - 1);
    };

    const startAuto = () => {
      stopAuto();
      intervalId = window.setInterval(next, 3500);
    };

    const stopAuto = () => {
      if (intervalId) {
        window.clearInterval(intervalId);
      }
    };

    const updateDragPosition = (clientX: number) => {
      const gap = getGap();
      const width = getItemWidth();
      const delta = clientX - startX;
      track.style.transition = 'none';
      track.style.transform = `translateX(${currentTranslate + delta}px)`;
    };

    const handleDragEnd = (clientX: number) => {
      const gap = getGap();
      const width = getItemWidth();
      const delta = clientX - startX;
      const threshold = (width + gap) * 0.2;
      track.style.transition = 'transform 700ms ease-in-out';

      if (delta < -threshold) {
        next();
      } else if (delta > threshold) {
        prev();
      } else {
        moveTo(index);
      }
    };

    track.addEventListener('transitionend', () => {
      if (index >= total * 2) {
        moveTo(total, { animate: false });
      } else if (index < total) {
        moveTo(total * 2 - 1, { animate: false });
      }
      isAnimating = false;
    });

    moveTo(index, { animate: false });
    startAuto();

    window.addEventListener('resize', () => moveTo(index, { animate: false }));
    carousel.addEventListener('mouseenter', stopAuto);
    carousel.addEventListener('mouseleave', startAuto);

    carousel.addEventListener('pointerdown', (event: Event) => {
      const pointerEvent = event as PointerEvent;
      isDragging = true;
      startX = pointerEvent.clientX;
      stopAuto();
      const gap = getGap();
      const width = getItemWidth();
      currentTranslate = -(index * (width + gap));
      carousel.classList.add('cursor-grabbing');
      track.setPointerCapture?.(pointerEvent.pointerId);
    });

    carousel.addEventListener('pointermove', (event: Event) => {
      if (!isDragging) return;
      updateDragPosition((event as PointerEvent).clientX);
    });

    const endDrag = (event: Event) => {
      if (!isDragging) return;
      const pointerEvent = event as PointerEvent;
      isDragging = false;
      carousel.classList.remove('cursor-grabbing');
      handleDragEnd(pointerEvent.clientX);
      startAuto();
    };

    carousel.addEventListener('pointerup', endDrag);
    carousel.addEventListener('pointerleave', endDrag);
    carousel.addEventListener('pointercancel', endDrag);
    carousel.addEventListener('dragstart', (event) => event.preventDefault());
  };

  initNocionesCarousel();
</script>
